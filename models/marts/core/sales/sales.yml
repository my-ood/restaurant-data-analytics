version: 2

models:
  - name: agg_hourly_sales
    description: >
      Hourly-level aggregate metrics including total revenue, items sold, and top category,
      with indicators for peak hours and weekend activity.
    config:
      tags: ['sales', 'hourly', 'kpis']
    columns:
      - name: order_hour_dt
        description: "The timestamp truncated to the hour (used for exact time bucketing)."
        tests: [not_null]
      - name: order_date
        description: "Date of the orders in this hourly window."
        tests: [not_null]
      - name: hour_of_day
        description: "Hour of the day (0–23)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 23
      - name: items_sold
        description: "Total number of items sold during the hour."
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: total_revenue
        description: "Total revenue during the hour."
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: distinct_tables
        description: "Number of unique tables served during the hour."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: total_orders
        description: "Count of unique order UUIDs placed during the hour."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: avg_spend_per_order
        description: "Average revenue per order in the hour."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: avg_items_per_order
        description: "Average number of items per order."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: unique_items_ordered
        description: "Number of distinct item UUIDs sold."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: top_category
        description: "Top-selling item category in the hour."
      - name: top_category_revenue
        description: "Revenue generated by the top-selling category."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: is_weekend
        description: "Flag indicating whether the order date falls on a weekend (Fri–Sun)."
        tests:
          - accepted_values:
              values: [true, false]
              quote: false
      - name: is_peak_hour
        description: "Boolean indicating if the hour was among the top 5 by revenue."
        tests:
          - accepted_values:
              values: [true, false]
              quote: false


  - name: agg_daily_sales
    description: >
      Daily sales KPIs aggregated from fct_orders, including revenue metrics, customer estimates,
      product diversity, and trends.
    config:
      tags: ['sales', 'daily', 'kpis', 'trends']
    columns:
      - name: order_date
        description: Date of the order (aggregation level).
        tests:
          - not_null
          - unique

      - name: total_revenue
        description: Total revenue across all items for the day.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: total_food_revenue
        description: Revenue from kitchen items only.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: pct_food_revenue
        description: Share of total revenue from food.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                between 0 and 1

      - name: total_drinks_revenue
        description: Revenue from bar items only.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: pct_drinks_revenue
        description: Share of total revenue from drinks.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                between 0 and 1

      - name: top_food_category
        description: Highest-grossing kitchen category.

      - name: top_food_category_revenue
        description: Revenue from the top kitchen category.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: pct_top_food_cat_revenue
        description: Top food category as part of kitchen revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                between 0 and 1

      - name: top_drinks_category
        description: Highest-grossing bar category.

      - name: top_drinks_category_revenue
        description: Revenue from the top bar category.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: pct_top_drinks_cat_revenue
        description: Top drinks category as part of bar revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                between 0 and 1

      - name: total_items_sold
        description: Total quantity of items sold.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: distinct_tables
        description: Count of unique tables used during the day.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: total_customers
        description: Total number of customers based on Mains/Steaks/Large Cuts.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: avg_spend_per_head
        description: Average revenue per estimated customer.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: revenue_per_item
        description: Average revenue per item sold.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: items_per_customer
        description: Average number of items per estimated customer.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: unique_items_ordered
        description: Count of unique item UUIDs ordered.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: food_category_diversity
        description: Number of distinct kitchen categories.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: drinks_category_diversity
        description: Number of distinct bar categories.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: is_weekend
        description: Whether the date falls on a Friday, Saturday or Sunday.
        tests:
          - accepted_values:
              values: [true, false]
              quote: false

      - name: revenue_change
        description: Day-over-day change in total revenue.
        
      - name: revenue_change_pct
        description: Percentage change in total revenue from previous day.
        
      - name: rolling_avg_revenue_7d
        description: 7-day rolling average of total revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: rolling_avg_items_sold_7d
        description: 7-day rolling average of items sold.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0

      - name: busiest_hour
        description: Hour of the day with the most items sold.
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                between 0 and 23


  - name: agg_weekly_sales
    description: >
      Optimized weekly aggregation of sales KPIs leveraging `agg_daily_sales` as a base.
      Includes customer estimates, category diversity, top items, and trends.
    config:
      tags: ['sales', 'weekly', 'kpis', 'trends', 'optimized']
    columns:
      - name: order_week
        description: ISO week identifier (YYYY-WW).
        tests:
          - not_null
          - unique

      - name: week_start_date
        description: First order date of the week.

      - name: week_end_date
        description: Last order date of the week.

      - name: total_revenue
        description: Total weekly revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_food_revenue
        description: Total kitchen revenue for the week.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: pct_food_revenue
        description: Share of revenue from food.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

      - name: total_drinks_revenue
        description: Total bar revenue for the week.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: pct_drinks_revenue
        description: Share of revenue from drinks.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

      - name: top_food_category
        description: Top-selling kitchen category of the week.
        tests:
          - accepted_values:
              values: ['Mains', 'Large Cuts', 'Steaks', 'Cheese', 'Sides', 'Sauces', 'Puddings', 'Ice-Cream & Sorbet', 'Extras', 'Chocolates', 'Starters']

      - name: top_food_category_revenue
        description: Revenue from the top kitchen category.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: pct_top_food_cat_revenue
        description: Top food category as part of kitchen revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

      - name: top_drinks_category
        description: Top-selling bar category of the week.
        tests:
          - accepted_values:
              values: ['Beers & Cider', 'Lo & No Alc', 'Port & Sherry', 'Ultimate Steakhouse Cocktails', 'Time & A Place',
                      'Rarities', 'The Sacred Six', 'Red Wines', 'Champagne & Sparkling', 'Rose Wines', 'Dessert Wines',
                      'White Wines', 'Magnums', 'Bordeaux', 'Burgundy']

      - name: top_drinks_category_revenue
        description: Revenue from the top bar category.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: pct_top_drinks_cat_revenue
        description: Top drinks category as part of bar revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

      - name: total_items_sold
        description: Total quantity of items sold during the


  - name: agg_monthly_sales
    description: >
      Optimized monthly aggregation of sales KPIs using agg_daily_sales as the base,
      including customer estimates, top items, category performance, and weekend distribution.
    config:
      tags: ['sales', 'monthly', 'kpis', 'trends']
    columns:
      - name: order_month
        description: Month of the order (YYYY-MM).
        tests:
          - not_null
          - unique

      - name: total_revenue
        description: Total revenue for the month.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_food_revenue
        description: Revenue from kitchen items.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: pct_food_revenue
        description: Share of food in total revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

      - name: total_drinks_revenue
        description: Revenue from bar items.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: pct_drinks_revenue
        description: Share of drinks in total revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

      - name: top_food_category
        description: Top-selling kitchen category.
        tests:
          - accepted_values:
              values: ['Mains', 'Large Cuts', 'Steaks', 'Cheese', 'Sides', 'Sauces', 'Puddings',
                      'Ice-Cream & Sorbet', 'Extras', 'Chocolates', 'Starters']

      - name: top_food_category_revenue
        description: Revenue from top kitchen category.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: pct_top_food_cat_revenue
        description: Top food category as part of food revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

      - name: top_drinks_category
        description: Top-selling bar category.
        tests:
          - accepted_values:
              values: ['Beers & Cider', 'Lo & No Alc', 'Port & Sherry', 'Ultimate Steakhouse Cocktails',
                      'Time & A Place', 'Rarities', 'The Sacred Six', 'Red Wines', 'Champagne & Sparkling',
                      'Rose Wines', 'Dessert Wines', 'White Wines', 'Magnums', 'Bordeaux', 'Burgundy']

      - name: top_drinks_category_revenue
        description: Revenue from top bar category.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: pct_top_drinks_cat_revenue
        description: Top drinks category as part of drinks revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

      - name: total_items_sold
        description: Total number of items sold.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: avg_distinct_tables
        description: Avg number of physical tables used per night.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_customers
        description: Total number of individual customers.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: avg_spend_per_head
        description: Avg spend per estimated customer.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: revenue_per_item
        description: Avg revenue per item sold.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: items_per_customer
        description: Avg number of items per estimated customer.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: unique_items_ordered
        description: Total number of distinct items ordered.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: food_category_diversity
        description: Number of distinct food categories ordered.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: drinks_category_diversity
        description: Number of distinct drink categories ordered.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: weekend_days
        description: Count of weekend days in the month (with at least one order).
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: revenue_change
        description: Month-over-month revenue delta.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: revenue_change_pct
        description: Month-over-month revenue change in percentage.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

      - name: rolling_avg_revenue_3m
        description: 3-month rolling avg of total revenue.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: rolling_avg_items_sold_3m
        description: 3-month rolling avg of total items sold.
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: busiest_hour
        description: Hour of the month with highest item volume.
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 23"

