version: 2

models:
  - name: agg_item_performance_total
    description: >
      Aggregated item performance metrics across all time, showing total units sold,
      total revenue, average preparation time, and percent contribution to total sales.
      Also includes performance tagging (e.g., underperformer, top-seller).
    config:
      tags: ['performance', 'menu_analysis']
    columns:
      - name: item_uuid
        description: "Unique identifier for the menu item."
        tests:
          - not_null
          - relationships:
              to: ref('dim_menu_items')
              field: item_uuid
      - name: item_name
        description: "Human-readable name of the menu item."
        tests: [not_null]
      - name: menu_source
        description: "Origin menu for the item (a_la_carte, wine, dessert, cocktails_and_beer)."
        tests:
          - not_null
          - accepted_values:
              values: ['a_la_carte', 'wine', 'dessert', 'cocktails_and_beer']
      - name: item_category
        description: "Category of the menu item (e.g., Starters, Red Wines)."
        tests: [not_null]
      - name: total_units_sold
        description: "Total number of units sold for this item."
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: >
                >= 0
      - name: total_revenue
        description: "Total revenue generated by this item."
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: >
                >= 0
      - name: avg_order_hour
        description: "Average hour the item is ordered at."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 24
      - name: percent_of_total_sales
        description: "Percent contribution of this item to total revenue."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 100
      - name: performance_flag
        description: "Optional performance tag (e.g., 'underperformer', 'bestseller')."

  - name: agg_item_performance_wk
    description: "Same structure as total, scoped to the past 7 days."
    config:
      tags: ['performance', 'weekly']

  - name: agg_item_performance_mo
    description: "Same structure as total, scoped to the past 30 days."
    config:
      tags: ['performance', 'monthly']

  - name: agg_category_performance
    description: >
      Aggregated performance metrics by category and menu source.
      Includes total performance, as well as metrics from the past 30 and 7 days.
    config:
      tags: ['performance', 'category_summary']
    columns:
      - name: category
        description: "Menu item category (e.g., Starters, Red Wines)."
        tests: [not_null]
      - name: menu_source
        description: "Origin menu for the item (a_la_carte, wine, etc.)."
        tests: [not_null]
      - name: total_units_sold
        description: "Total quantity of items sold in this category."
      - name: total_revenue
        description: "Total revenue generated by this category."
      - name: avg_price
        description: "Average price of items in this category."
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: >
                >= 0
      - name: avg_price_per_unit
        description: "Average revenue per unit sold."
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: >
                >= 0
      - name: total_units_sold_30d
        description: "Total units sold in the last 30 days."
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0
      - name: total_revenue_30d
        description: "Total revenue in the last 30 days."
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0
      - name: total_units_sold_7d
        description: "Total units sold in the last 7 days."
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0
      - name: total_revenue_7d
        description: "Total revenue in the last 7 days."
        tests:
          - dbt_utils.expression_is_true:
              expression: >
                >= 0
